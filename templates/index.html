<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emotion Detection AI</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
  <div class="main-container">
    <!-- Hero Section -->
    <section class="hero-section">
      <h1 class="hero-title">Emotion Detection AI</h1>
      <p class="hero-subtitle">Upload an image or use your webcam to detect emotions in real-time using advanced machine learning.</p>
    </section>

    <!-- Upload Card -->
    <div class="main-card">
      <!-- User Info Form -->
      <div class="mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="nameInput" class="form-label">Name <span style="color: var(--accent-red);">*</span></label>
            <input type="text" class="form-control" id="nameInput" placeholder="Enter your name" required />
          </div>
          <div class="col-md-6 mb-3">
            <label for="emailInput" class="form-label">Email (Optional)</label>
            <input type="email" class="form-control" id="emailInput" placeholder="Enter your email" />
          </div>
        </div>
      </div>

      <!-- Upload Area -->
      <div class="upload-area" id="uploadArea">
        <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
        <div class="upload-text">Drag & Drop or Click to Upload</div>
        <div class="upload-subtext">Supported formats: JPG, PNG, GIF, BMP</div>
        <div class="file-name hidden" id="fileName"></div>
        <input type="file" id="imageInput" accept="image/*" class="hidden" />
      </div>

      <!-- Image Preview -->
      <div id="uploadPreviewContainer" class="image-preview-container hidden">
        <div class="preview-label">
          <i class="fa-solid fa-image"></i> Image Preview
        </div>
        <img id="uploadPreview" class="image-preview" alt="Preview" />
        <button class="btn remove-image-btn" id="removeUploadBtn">
          <i class="fa-solid fa-trash"></i> Remove Image
        </button>
      </div>

      <!-- Error Display -->
      <div id="errorAlert" class="alert alert-danger mt-3 hidden" role="alert">
        <i class="fa-solid fa-exclamation-circle"></i> <span id="errorMessage"></span>
      </div>

      <!-- Detect Button -->
      <div class="text-center mt-4">
        <button class="btn btn-primary" id="detectButton">
          <span id="detectButtonText"><i class="fa-solid fa-face-smile"></i> Detect Emotion</span>
          <span id="detectButtonSpinner" class="hidden">
            <span class="spinner-border spinner-border-sm me-2"></span>Analyzing...
          </span>
        </button>
      </div>
    </div>

    <!-- Camera Section -->
    <div class="camera-section">
      <h3 class="camera-title"><i class="fa-solid fa-camera"></i> Live Camera Detection</h3>
      
      <div class="video-container hidden" id="videoContainer">
        <video id="cameraFeed" width="100%" autoplay muted playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
      </div>

      <!-- Camera Captured Image Preview -->
      <div id="cameraPreviewContainer" class="image-preview-container hidden">
        <div class="preview-label">
          <i class="fa-solid fa-camera"></i> Captured Image
        </div>
        <img id="cameraPreview" class="image-preview" alt="Captured" />
        <button class="btn remove-image-btn" id="removeCameraBtn">
          <i class="fa-solid fa-trash"></i> Retake Picture
        </button>
      </div>

      <div class="mt-3">
        <button class="btn btn-secondary" id="startCameraBtn">
          <i class="fa-solid fa-play"></i> Start Camera
        </button>
        <button class="btn btn-success hidden" id="captureBtn">
          <i class="fa-solid fa-camera"></i> Take Picture
        </button>
        <button class="btn btn-primary hidden" id="analyzeCameraBtn">
          <i class="fa-solid fa-face-smile"></i> Analyze Picture
        </button>
        <button class="btn btn-secondary hidden" id="stopCameraBtn">
          <i class="fa-solid fa-stop"></i> Stop Camera
        </button>
      </div>
    </div>

    <!-- Results Section -->
    <div id="resultSection" class="result-card hidden">
      <h3 class="mb-3"><i class="fa-solid fa-chart-line"></i> Analysis Results</h3>
      <div class="primary-emotion" id="primaryEmotion">ðŸ˜Š Happy</div>
      <div class="confidence-display">Confidence: <span id="confidence">95%</span></div>
      <p class="text-muted mt-2" id="resultMessage"></p>

      <div class="emotion-breakdown" id="emotionBreakdown">
        <!-- Will be populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    // === Element References ===
    const uploadArea = document.getElementById("uploadArea");
    const imageInput = document.getElementById("imageInput");
    const detectButton = document.getElementById("detectButton");
    const detectButtonText = document.getElementById("detectButtonText");
    const detectButtonSpinner = document.getElementById("detectButtonSpinner");
    const resultSection = document.getElementById("resultSection");
    const errorAlert = document.getElementById("errorAlert");
    const errorMessage = document.getElementById("errorMessage");
    const fileName = document.getElementById("fileName");
    const nameInput = document.getElementById("nameInput");
    const emailInput = document.getElementById("emailInput");
    const uploadPreview = document.getElementById("uploadPreview");
    const uploadPreviewContainer = document.getElementById("uploadPreviewContainer");
    const removeUploadBtn = document.getElementById("removeUploadBtn");

    // Camera elements
    const startCameraBtn = document.getElementById("startCameraBtn");
    const captureBtn = document.getElementById("captureBtn");
    const analyzeCameraBtn = document.getElementById("analyzeCameraBtn");
    const stopCameraBtn = document.getElementById("stopCameraBtn");
    const video = document.getElementById("cameraFeed");
    const canvas = document.getElementById("canvas");
    const videoContainer = document.getElementById("videoContainer");
    const cameraPreview = document.getElementById("cameraPreview");
    const cameraPreviewContainer = document.getElementById("cameraPreviewContainer");
    const removeCameraBtn = document.getElementById("removeCameraBtn");

    let stream;
    let selectedFile = null;
    let capturedImageData = null;

    // === Emotion Icons Mapping ===
    const emotionIcons = {
      'happy': 'ðŸ˜Š',
      'sad': 'ðŸ˜¢',
      'angry': 'ðŸ˜ ',
      'surprise': 'ðŸ˜²',
      'fear': 'ðŸ˜¨',
      'disgust': 'ðŸ¤¢',
      'neutral': 'ðŸ˜'
    };

    // === Upload Area Click ===
    uploadArea.addEventListener("click", () => imageInput.click());

    // === File Selection ===
    imageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        fileName.textContent = `${file.name}`;
        fileName.classList.remove("hidden");
        uploadArea.classList.add("has-file");
        
        // Show image preview
        const reader = new FileReader();
        reader.onload = (event) => {
          uploadPreview.src = event.target.result;
          uploadPreviewContainer.classList.remove("hidden");
          console.log("Upload preview loaded");
        };
        reader.onerror = (error) => {
          console.error("Error reading file:", error);
        };
        reader.readAsDataURL(file);
        
        hideError();
      }
    });

    // === Remove Uploaded Image ===
    removeUploadBtn.addEventListener("click", (e) => {
      e.preventDefault();
      selectedFile = null;
      imageInput.value = "";
      fileName.classList.add("hidden");
      uploadArea.classList.remove("has-file");
      uploadPreviewContainer.classList.add("hidden");
      uploadPreview.src = "";
      resultSection.classList.add("hidden");
      console.log("Upload preview cleared");
    });

    // === Drag & Drop Support ===
    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "var(--accent-teal)";
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.style.borderColor = "var(--border-faint)";
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = "var(--border-faint)";
      
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith("image/")) {
        selectedFile = file;
        imageInput.files = e.dataTransfer.files;
        fileName.textContent = `${file.name}`;
        fileName.classList.remove("hidden");
        uploadArea.classList.add("has-file");
        
        // Show image preview
        const reader = new FileReader();
        reader.onload = (event) => {
          uploadPreview.src = event.target.result;
          uploadPreviewContainer.classList.remove("hidden");
          console.log("Dropped image preview loaded");
        };
        reader.onerror = (error) => {
          console.error("Error reading dropped file:", error);
        };
        reader.readAsDataURL(file);
        
        hideError();
      }
    });

    // === Detect Emotion (Upload) ===
    detectButton.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();

      // Validation
      if (!name) {
        showError("Please enter your name");
        nameInput.focus();
        return;
      }

      if (!selectedFile) {
        showError("Please select an image file");
        return;
      }

      // Show loading state
      detectButton.disabled = true;
      detectButtonText.classList.add("hidden");
      detectButtonSpinner.classList.remove("hidden");
      hideError();
      resultSection.classList.add("hidden");

      // Create FormData
      const formData = new FormData();
      formData.append("name", name);
      formData.append("email", email);
      formData.append("file", selectedFile);

      try {
        const response = await fetch("/upload", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          displayResults(data);
        } else {
          showError(data.error || "Failed to analyze image");
        }
      } catch (error) {
        showError("Network error. Please try again.");
        console.error("Error:", error);
      } finally {
        // Reset button state
        detectButton.disabled = false;
        detectButtonText.classList.remove("hidden");
        detectButtonSpinner.classList.add("hidden");
      }
    });

    // === Camera Controls ===
    startCameraBtn.addEventListener("click", async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: 640, height: 480 } 
        });
        video.srcObject = stream;
        videoContainer.classList.remove("hidden");
        startCameraBtn.classList.add("hidden");
        captureBtn.classList.remove("hidden");
        stopCameraBtn.classList.remove("hidden");
      } catch (err) {
        showError("Camera access denied! Please allow camera permissions.");
        console.error("Camera error:", err);
      }
    });

    captureBtn.addEventListener("click", () => {
      // Capture image from video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      // Convert to base64
      capturedImageData = canvas.toDataURL("image/jpeg");

      // Show preview
      cameraPreview.src = capturedImageData;
      cameraPreviewContainer.classList.remove("hidden");
      console.log("Camera preview loaded");
      
      // Hide video, show analyze button
      videoContainer.classList.add("hidden");
      captureBtn.classList.add("hidden");
      analyzeCameraBtn.classList.remove("hidden");
      
      hideError();
    });

    analyzeCameraBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();

      if (!name) {
        showError("Please enter your name in the form above");
        nameInput.focus();
        nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      if (!capturedImageData) {
        showError("No image captured. Please take a picture first.");
        return;
      }

      // Show loading
      analyzeCameraBtn.disabled = true;
      analyzeCameraBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
      hideError();
      resultSection.classList.add("hidden");

      try {
        const response = await fetch("/process_live_image", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name: name,
            email: email,
            image: capturedImageData,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          displayResults({
            success: true,
            emotion: data.emotion,
            confidence: data.confidence,
            all_emotions: data.all_emotions,
            message: data.message
          });
        } else {
          showError(data.error || "Failed to analyze image");
        }
      } catch (error) {
        showError("Network error. Please try again.");
        console.error("Error:", error);
      } finally {
        analyzeCameraBtn.disabled = false;
        analyzeCameraBtn.innerHTML = '<i class="fa-solid fa-face-smile"></i> Analyze Picture';
      }
    });

    removeCameraBtn.addEventListener("click", (e) => {
      e.preventDefault();
      // Clear captured image and show video again
      capturedImageData = null;
      cameraPreview.src = "";
      cameraPreviewContainer.classList.add("hidden");
      videoContainer.classList.remove("hidden");
      captureBtn.classList.remove("hidden");
      analyzeCameraBtn.classList.add("hidden");
      resultSection.classList.add("hidden");
      console.log("Camera preview cleared");
    });

    stopCameraBtn.addEventListener("click", () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      capturedImageData = null;
      videoContainer.classList.add("hidden");
      cameraPreviewContainer.classList.add("hidden");
      startCameraBtn.classList.remove("hidden");
      captureBtn.classList.add("hidden");
      analyzeCameraBtn.classList.add("hidden");
      stopCameraBtn.classList.add("hidden");
      resultSection.classList.add("hidden");
    });

    // === Display Results ===
    function displayResults(data) {
      const emotion = data.emotion;
      const confidence = data.confidence;
      const allEmotions = data.all_emotions;

      // Update primary emotion
      const icon = emotionIcons[emotion] || 'ðŸŽ­';
      document.getElementById("primaryEmotion").textContent = `${icon} ${emotion.charAt(0).toUpperCase() + emotion.slice(1)}`;
      document.getElementById("confidence").textContent = `${(confidence * 100).toFixed(1)}%`;
      document.getElementById("resultMessage").textContent = data.message || '';

      // Update emotion breakdown
      const breakdownHtml = Object.entries(allEmotions)
        .sort((a, b) => b[1] - a[1])
        .map(([emo, percentage]) => {
          const isPrimary = emo === emotion;
          const barClass = isPrimary ? 'emotion-bar primary-emotion-bar' : 'emotion-bar';
          const icon = emotionIcons[emo] || 'ðŸŽ­';
          
          return `
            <div class="${barClass} d-flex justify-content-between align-items-center">
              <span>${icon} ${emo.charAt(0).toUpperCase() + emo.slice(1)}</span>
              <span class="emotion-percentage">${percentage.toFixed(1)}%</span>
            </div>
          `;
        })
        .join('');

      document.getElementById("emotionBreakdown").innerHTML = breakdownHtml;

      // Show results
      resultSection.classList.remove("hidden");
      resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // === Error Handling ===
    function showError(message) {
      errorMessage.textContent = message;
      errorAlert.classList.remove("hidden");
      errorAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideError() {
      errorAlert.classList.add("hidden");
    }
  </script>
</body>
</html>
